---
title: "An√°lise Textual de PDF com Agrupamento de Palavras"
author: "https://github.com/walterlijunior/SCRIPT-EM-R-PARA-ANALISE-TEXTUAL"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: flatly
    df_print: paged
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
# Aumentar o limite de upload para 30MB
options(shiny.maxRequestSize = 30*1024^2)  # 30MB
# Carregar todas as bibliotecas necess√°rias
library(shiny)
library(pdftools)
library(tm)
library(wordcloud)
library(ggplot2)
library(RColorBrewer)
library(tidytext)    # Para tokeniza√ß√£o
library(dplyr)       # Para manipula√ß√£o de dados
library(stringr)     # Para fun√ß√µes de string
library(tibble)      # Para criar tibbles
library(stringdist)  # Para calcular dist√¢ncia entre strings
library(DT)          # Para tabelas interativas
library(scales)      # Para formata√ß√£o de percentuais
```

## üì• Upload e An√°lise do Arquivo PDF

```{r ui-upload, echo=FALSE}
fluidRow(
  column(6, 
    fileInput("arquivo_pdf", "Escolha um arquivo PDF", 
              accept = ".pdf",
              buttonLabel = "Procurar...")
  ),
  column(6,
    actionButton("analisar", "Analisar Documento", 
                icon = icon("play"),
                class = "btn-primary",
                style = "margin-top: 25px;")
  )
)
```

```{r server-analise, echo=FALSE}
# Vari√°veis reativas para controlar o estado da an√°lise
analise_realizada <- reactiveValues(valor = FALSE)
total_palavras <- reactiveVal(0)

# Observer para o bot√£o de an√°lise
observeEvent(input$analisar, {
  req(input$arquivo_pdf)
  analise_realizada$valor <- TRUE
})

# Texto extra√≠do do PDF
output_text <- reactive({
  req(input$arquivo_pdf)
  req(analise_realizada$valor)
  # Extrair todas as p√°ginas do PDF e manter a formata√ß√£o por p√°gina
  texto_pdf <- pdftools::pdf_text(input$arquivo_pdf$datapath)
  return(texto_pdf)  # Retorna um vetor com cada p√°gina como um elemento
})

# Fun√ß√£o para normalizar palavras (remover acentos, converter para min√∫sculas, etc.)
normalizar_palavra <- function(palavra) {
  # Converter para min√∫sculas
  palavra <- tolower(palavra)
  
  # Remover acentos e caracteres especiais
  palavra <- iconv(palavra, to = "ASCII//TRANSLIT")
  
  # Substitui√ß√µes espec√≠ficas (pode ser expandido conforme necess√°rio)
  palavra <- gsub("√ß", "c", palavra)
  palavra <- gsub("√£", "a", palavra)
  palavra <- gsub("√µ", "o", palavra)
  palavra <- gsub("√°|√†|√¢", "a", palavra)
  palavra <- gsub("√©|√®|√™", "e", palavra)
  palavra <- gsub("√≠|√¨|√Æ", "i", palavra)
  palavra <- gsub("√≥|√≤|√¥", "o", palavra)
  palavra <- gsub("√∫|√π|√ª", "u", palavra)
  
  return(palavra)
}

# Fun√ß√£o corrigida para agrupar palavras similares 
agrupar_palavras_similares <- function(termos, threshold = 0.2) {
  # Se n√£o h√° termos, retorna uma lista vazia
  if (nrow(termos) == 0) {
    return(termos)
  }
  
  # Normalizar todas as palavras
  termos$termo_normalizado <- sapply(termos$termo, normalizar_palavra)
  
  # Criar um data frame para armazenar o resultado final
  resultado <- data.frame(
    termo = character(),
    frequencia = numeric(),
    variantes = character(),
    stringsAsFactors = FALSE
  )
  
  # Agrupar por termo normalizado
  termos_agrupados <- split(termos, termos$termo_normalizado)
  
  # Para cada grupo, criar uma entrada no resultado
  for (grupo_nome in names(termos_agrupados)) {
    grupo <- termos_agrupados[[grupo_nome]]
    
    # Pegar o termo mais frequente como principal
    idx_principal <- which.max(grupo$frequencia)
    termo_principal <- grupo$termo[idx_principal]
    
    # Obter variantes (excluindo o termo principal)
    variantes <- grupo$termo[grupo$termo != termo_principal]
    
    # Calcular frequ√™ncia total
    freq_total <- sum(grupo$frequencia)
    
    # Variantes como string, ou "nenhuma" se n√£o houver
    variantes_str <- if (length(variantes) > 0) paste(variantes, collapse = ", ") else "nenhuma"
    
    # Adicionar ao resultado
    resultado <- rbind(resultado, data.frame(
      termo = termo_principal,
      frequencia = freq_total,
      variantes = variantes_str,
      stringsAsFactors = FALSE
    ))
  }
  
  # Ordenar por frequ√™ncia
  resultado <- resultado[order(resultado$frequencia, decreasing = TRUE), ]
  
  # Garantir que o data frame tenha rownames corretos e consecutivos
  rownames(resultado) <- 1:nrow(resultado)
  
  return(resultado)
}

# Tokeniza√ß√£o do texto para frequ√™ncia mais precisa
texto_tokenizado <- reactive({
  req(output_text())
  
  # Combinar todas as p√°ginas
  texto_completo <- paste(output_text(), collapse = " ")
  
  # Usar tibble e unnest_tokens para processamento mais preciso
  tokens <- tibble(texto = texto_completo) %>%
    unnest_tokens(palavra, texto) %>%
    # Filtragem adicional
    filter(nchar(palavra) > 1) %>%
    # Remover stopwords
    anti_join(tibble(palavra = stopwords("portuguese")), by = "palavra")
  
  # Atualizar o contador total de palavras
  total_palavras(nrow(tokens))
  
  return(tokens)
})

# An√°lise de frequ√™ncia de termos usando a abordagem do tidytext
frequencia_termos <- reactive({
  req(texto_tokenizado())
  
  # Contar ocorr√™ncias e ordenar
  termos <- texto_tokenizado() %>%
    count(palavra, sort = TRUE) %>%
    rename(termo = palavra, frequencia = n)
  
  # Calcular percentual
  termos <- termos %>%
    mutate(percentual = frequencia / sum(frequencia) * 100)
    
  return(termos)
})

# Frequ√™ncia de termos agrupados (palavras similares)
frequencia_termos_agrupados <- reactive({
  req(frequencia_termos())
  
  # Agrupar palavras similares
  termos_agrupados <- agrupar_palavras_similares(frequencia_termos())
  
  # Calcular percentual
  termos_agrupados <- termos_agrupados %>%
    mutate(percentual = frequencia / sum(frequencia) * 100)
  
  return(termos_agrupados)
})

# Termos menos frequentes (palavras raras)
termos_raros <- reactive({
  req(frequencia_termos())
  
  # Pegar os termos menos frequentes (ordenados por frequ√™ncia crescente)
  termos <- frequencia_termos() %>%
    arrange(frequencia) %>%
    mutate(percentual = frequencia / sum(frequencia) * 100)
  
  return(termos)
})

# Termos raros agrupados
termos_raros_agrupados <- reactive({
  req(frequencia_termos_agrupados())
  
  # Ordenar por frequ√™ncia crescente
  termos <- frequencia_termos_agrupados() %>%
    arrange(frequencia) %>%
    mutate(percentual = frequencia / sum(frequencia) * 100)
  
  return(termos)
})

# Fun√ß√£o de busca inteligente para encontrar palavras com prefixo
buscar_palavra_inteligente <- function(texto, termo, case_sensitive = FALSE) {
  # Verificar se o termo est√° vazio
  if (trimws(termo) == "") {
    return(list(
      total = 0,
      por_pagina = rep(0, length(texto)),
      posicoes = list(),
      palavras_encontradas = character(0)
    ))
  }
  
  # Normalizar o termo de busca
  termo_norm <- normalizar_palavra(termo)
  
  # Preparar o padr√£o de busca para correspond√™ncia parcial
  if (!case_sensitive) {
    padrao <- paste0("\\b", tolower(termo), "\\w*\\b")
    texto_proc <- tolower(texto)
    
    # Variantes com acentos e cedilhas
    variantes <- c(
      paste0("\\b", gsub("c", "[c√ß]", termo_norm), "\\w*\\b"),
      paste0("\\b", gsub("a", "[a√°√†√£√¢]", termo_norm), "\\w*\\b"),
      paste0("\\b", gsub("e", "[e√©√®√™]", termo_norm), "\\w*\\b"),
      paste0("\\b", gsub("i", "[i√≠√¨√Æ]", termo_norm), "\\w*\\b"),
      paste0("\\b", gsub("o", "[o√≥√≤√¥√µ]", termo_norm), "\\w*\\b"),
      paste0("\\b", gsub("u", "[u√∫√π√ª]", termo_norm), "\\w*\\b")
    )
    
    # Remover padr√µes duplicados
    variantes <- unique(variantes)
  } else {
    padrao <- paste0("\\b", termo, "\\w*\\b")
    texto_proc <- texto
    variantes <- c()
  }
  
  # Lista para armazenar palavras completas encontradas
  palavras_encontradas <- list()
  
  # Fun√ß√£o para encontrar matches com um padr√£o
  find_matches <- function(texto, padrao) {
    matches_list <- lapply(seq_along(texto), function(i) {
      pagina <- texto[i]
      matches <- gregexpr(padrao, pagina, ignore.case = !case_sensitive)
      
      if (matches[[1]][1] != -1) {
        starts <- matches[[1]]
        lengths <- attr(matches[[1]], "match.length")
        
        palavras <- mapply(function(start, length) {
          substr(pagina, start, start + length - 1)
        }, starts, lengths, SIMPLIFY = FALSE)
        
        list(
          pagina = i,
          ocorrencias = length(starts),
          palavras = unlist(palavras)
        )
      } else {
        NULL
      }
    })
    
    # Filtrar resultados nulos
    matches_list[!sapply(matches_list, is.null)]
  }
  
  # Buscar com o padr√£o principal
  matches_principal <- find_matches(texto_proc, padrao)
  
  # Buscar com variantes se n√£o for case sensitive
  matches_variantes <- list()
  if (!case_sensitive && length(variantes) > 0) {
    for (var_padrao in variantes) {
      matches_var <- find_matches(texto_proc, var_padrao)
      if (length(matches_var) > 0) {
        matches_variantes <- c(matches_variantes, matches_var)
      }
    }
  }
  
  # Combinar resultados
  todos_matches <- c(matches_principal, matches_variantes)
  
  # Se n√£o h√° resultados, retornar uma lista vazia
  if (length(todos_matches) == 0) {
    return(list(
      total = 0,
      por_pagina = rep(0, length(texto)),
      posicoes = list(),
      palavras_encontradas = character(0)
    ))
  }
  
  # Extrair todas as palavras encontradas
  todas_palavras <- unique(unlist(lapply(todos_matches, function(m) m$palavras)))
  
  # Contar ocorr√™ncias por p√°gina
  ocorrencias_pagina <- rep(0, length(texto))
  for (match in todos_matches) {
    ocorrencias_pagina[match$pagina] <- ocorrencias_pagina[match$pagina] + match$ocorrencias
  }
  
  # Preparar posi√ß√µes para destaque
  posicoes <- lapply(seq_along(texto_proc), function(i) {
    matches_pagina <- Filter(function(m) m$pagina == i, todos_matches)
    
    if (length(matches_pagina) > 0) {
      # Extrair todas as palavras encontradas nesta p√°gina
      palavras_pagina <- unique(unlist(lapply(matches_pagina, function(m) m$palavras)))
      
      # Localizar posi√ß√µes de cada palavra
      pos_list <- lapply(palavras_pagina, function(palavra) {
        palavra_padrao <- paste0("\\b", palavra, "\\b")
        word_matches <- gregexpr(palavra_padrao, texto_proc[i], ignore.case = !case_sensitive)
        
        if (word_matches[[1]][1] != -1) {
          starts <- word_matches[[1]]
          lengths <- attr(word_matches[[1]], "match.length")
          
          data.frame(
            palavra = palavra,
            inicio = starts,
            fim = starts + lengths - 1
          )
        } else {
          NULL
        }
      })
      
      # Combinar os resultados
      pos_df <- do.call(rbind, pos_list[!sapply(pos_list, is.null)])
      
      if (!is.null(pos_df) && nrow(pos_df) > 0) {
        list(
          pagina = i,
          posicoes = pos_df
        )
      } else {
        NULL
      }
    } else {
      NULL
    }
  })
  
  # Filtrar posi√ß√µes nulas
  posicoes <- posicoes[!sapply(posicoes, is.null)]
  
  list(
    total = sum(ocorrencias_pagina),
    por_pagina = ocorrencias_pagina,
    posicoes = posicoes,
    palavras_encontradas = todas_palavras
  )
}
```

## üìä Resultados da An√°lise

```{r ui-resultados, echo=FALSE}
# Mostrar os resultados apenas quando a an√°lise for executada
conditionalPanel(
  condition = "input.analisar",
  # Mostrar contador de palavras
  div(
    class = "well well-sm",
    style = "text-align: center; background-color: #f0f8ff; border-left: 4px solid #007bff;",
    h4(
      icon("info-circle"), 
      textOutput("contador_palavras", inline = TRUE)
    )
  ),
  tabsetPanel(
    tabPanel("Texto Extra√≠do", 
      h4("Texto do PDF (por p√°gina):"),
      uiOutput("paginas_pdf")
    ),
    tabPanel("Termos Frequentes",
      fluidRow(
        column(4,
          radioButtons("tipo_contagem", "Tipo de contagem:", 
                    choices = c("Individual" = "individual", 
                                "Agrupada (palavras similares)" = "agrupada"),
                    selected = "agrupada"),
          h4("Controle de Frequ√™ncia:"),
          sliderInput("min_freq", "Frequ√™ncia m√≠nima:", 
                      min = 1, max = 10, value = 1, step = 1)
        ),
        column(8,
          h4("Buscador Inteligente:"),
          fluidRow(
            column(7, textInput("busca_termo", "Digite parte da palavra:", placeholder = "Ex: manuten")),
            column(3, checkboxInput("case_sensitive", "Diferenciar mai√∫sculas/min√∫sculas", FALSE)),
            column(2, actionButton("buscar", "Buscar", class = "btn-info"))
          ),
          uiOutput("resultado_busca")
        )
      ),
      h4("Tabela de Termos Mais Frequentes"),
      DTOutput("tabela_termos_dt"),
      h4("Gr√°fico de Barras (Top 10)"),
      plotOutput("grafico_barras")
    ),
    tabPanel("Termos Raros",
      h4("Palavras Menos Frequentes no Documento"),
      fluidRow(
        column(4,
          radioButtons("tipo_contagem_raros", "Tipo de contagem:", 
                     choices = c("Individual" = "individual", 
                                "Agrupada (palavras similares)" = "agrupada"),
                     selected = "agrupada"),
          sliderInput("max_freq", "Frequ√™ncia m√°xima:", 
                     min = 1, max = 10, value = 3, step = 1),
          numericInput("num_raros", "N√∫mero de termos a exibir:", 
                      min = 5, max = 100, value = 20)
        ),
        column(8,
          h4("Gr√°fico de Termos Raros"),
          plotOutput("grafico_raros")
        )
      ),
      h4("Tabela de Termos Raros"),
      DTOutput("tabela_raros_dt")
    ),
    tabPanel("Nuvem de Palavras",
      h4("Visualiza√ß√£o dos Termos Mais Frequentes"),
      fluidRow(
        column(3, 
          radioButtons("tipo_contagem_nuvem", "Tipo de contagem:", 
                     choices = c("Individual" = "individual", 
                                "Agrupada (palavras similares)" = "agrupada"),
                     selected = "agrupada", inline = TRUE)
        ),
        column(4, 
          sliderInput("min_freq_nuvem", "Frequ√™ncia m√≠nima:", 
                    min = 1, max = 10, value = 1, step = 1)
        ),
        column(3, 
          numericInput("max_palavras", "M√°ximo de palavras:", 
                      min = 20, max = 300, value = 100)
        ),
        column(2,
          checkboxInput("mostrar_raras", "Mostrar palavras raras", FALSE)
        )
      ),
      plotOutput("nuvem_palavras", height = "500px")
    ),
    tabPanel("Buscador Avan√ßado",
      h4("Busca Avan√ßada no Documento"),
      p("Digite parte da palavra para encontrar todas as palavras que come√ßam com esse prefixo, incluindo varia√ß√µes com/sem acentos"),
      fluidRow(
        column(6, textInput("busca_avancada", "Digite parte da palavra:", placeholder = "Ex: manuten")),
        column(3, checkboxInput("case_sensitive_avancado", "Diferenciar mai√∫sculas/min√∫sculas", FALSE)),
        column(3, actionButton("buscar_avancado", "Buscar", class = "btn-primary"))
      ),
      br(),
      # √Årea para exibir palavras encontradas
      uiOutput("palavras_encontradas"),
      # √Årea para exibir resultados da busca
      uiOutput("resultado_busca_avancada"),
      hr(),
      h4("Visualiza√ß√£o do Texto com Destaque:"),
      uiOutput("texto_destacado")
    )
  )
)
```

```{r server-resultados, echo=FALSE}
# Exibir contador de palavras
output$contador_palavras <- renderText({
  paste("O documento cont√©m um total de", total_palavras(), "palavras relevantes ap√≥s a remo√ß√£o de stopwords.")
})

# Mostrar texto extra√≠do p√°gina por p√°gina com formata√ß√£o melhorada
output$paginas_pdf <- renderUI({
  req(output_text())
  
  # Criar uma lista de elementos UI para cada p√°gina
  paginas <- lapply(seq_along(output_text()), function(i) {
    # Para cada p√°gina, criar um painel
    wellPanel(
      h5(paste("P√°gina", i)),
      tags$pre(
        style = "white-space: pre-wrap; word-wrap: break-word; max-height: 300px; overflow-y: auto;",
        output_text()[i]
      )
    )
  })
  
  # Combinar todos os elementos em um √∫nico objeto UI
  do.call(tagList, paginas)
})

# Tabela melhorada de termos frequentes com DataTables
output$tabela_termos_dt <- renderDT({
  req(input$min_freq)
  
  if (input$tipo_contagem == "individual") {
    req(frequencia_termos())
    df <- frequencia_termos() %>%
      filter(frequencia >= input$min_freq) %>%
      head(50) %>%
      mutate(percentual = paste0(round(percentual, 2), "%"))
    
    # Renomear colunas para exibi√ß√£o
    colnames(df) <- c("Termo", "Frequ√™ncia", "Percentual (%)")
    
  } else {
    req(frequencia_termos_agrupados())
    df <- frequencia_termos_agrupados() %>%
      filter(frequencia >= input$min_freq) %>%
      head(50) %>%
      mutate(percentual = paste0(round(percentual, 2), "%"))
    
    # Renomear colunas para exibi√ß√£o
    colnames(df) <- c("Termo", "Frequ√™ncia", "Variantes", "Percentual (%)")
  }
  
  datatable(df, rownames = FALSE, options = list(
    pageLength = 10,
    lengthMenu = c(10, 25, 50),
    dom = 'Blfrtip',
    buttons = c('copy', 'csv', 'excel', 'pdf')
  ))
})

# Tabela de termos raros com DataTables
output$tabela_raros_dt <- renderDT({
  req(input$max_freq, input$num_raros)
  
  if (input$tipo_contagem_raros == "individual") {
    req(termos_raros())
    df <- termos_raros() %>%
      filter(frequencia <= input$max_freq) %>%
      head(input$num_raros) %>%
      mutate(percentual = paste0(round(percentual, 2), "%"))
    
    # Renomear colunas para exibi√ß√£o
    colnames(df) <- c("Termo", "Frequ√™ncia", "Percentual (%)")
    
  } else {
    req(termos_raros_agrupados())
    df <- termos_raros_agrupados() %>%
      filter(frequencia <= input$max_freq) %>%
      head(input$num_raros) %>%
      mutate(percentual = paste0(round(percentual, 2), "%"))
    
    # Renomear colunas para exibi√ß√£o
    colnames(df) <- c("Termo", "Frequ√™ncia", "Variantes", "Percentual (%)")
  }
  
  datatable(df, rownames = FALSE, options = list(
    pageLength = 10,
    lengthMenu = c(10, 25, 50),
    dom = 'Blfrtip',
    buttons = c('copy', 'csv', 'excel', 'pdf')
  ))
})

# Gr√°fico de barras atualizado com percentuais
output$grafico_barras <- renderPlot({
  req(input$min_freq)
  
  if (input$tipo_contagem == "individual") {
    req(frequencia_termos())
    # Filtrar por frequ√™ncia m√≠nima e pegar os top 10
    top <- frequencia_termos() %>%
      filter(frequencia >= input$min_freq) %>%
      head(10)
    
    # Garantir que n√£o h√° valores NA
    top <- top[complete.cases(top), ]
    
    # Criar o gr√°fico de barras
    if (nrow(top) > 0) {
      ggplot(top, aes(x = reorder(termo, frequencia), y = frequencia)) +
        geom_bar(stat = "identity", fill = "steelblue") +
        geom_text(aes(label = paste0(frequencia, " (", round(percentual, 1), "%)")), 
                 hjust = -0.1, size = 3.5) +  # Mostrar frequ√™ncia e percentual
        coord_flip() +
        labs(title = "Top 10 Termos", x = "Termo", y = "Frequ√™ncia") +
        theme_minimal() +
        theme(axis.text.y = element_text(size = 11)) +
        scale_y_continuous(expand = expansion(mult = c(0, 0.3)))  # Espa√ßo para r√≥tulos
    } else {
      # Gr√°fico vazio se n√£o houver dados
      ggplot() + 
        annotate("text", x = 0.5, y = 0.5, label = "Sem dados para exibir") +
        theme_void() +
        xlim(0, 1) + ylim(0, 1)
    }
  } else {
    req(frequencia_termos_agrupados())
    # Filtrar por frequ√™ncia m√≠nima e pegar os top 10
    top <- frequencia_termos_agrupados() %>%
      filter(frequencia >= input$min_freq) %>%
      head(10)
    
    # Garantir que n√£o h√° valores NA
    top <- top[complete.cases(top), ]
    
    # Criar o gr√°fico de barras
    if (nrow(top) > 0) {
      ggplot(top, aes(x = reorder(termo, frequencia), y = frequencia)) +
        geom_bar(stat = "identity", fill = "steelblue") +
        geom_text(aes(label = paste0(frequencia, " (", round(percentual, 1), "%)")), 
                 hjust = -0.1, size = 3.5) +  # Mostrar frequ√™ncia e percentual
        coord_flip() +
        labs(title = "Top 10 Termos (Agrupados)", x = "Termo", y = "Frequ√™ncia") +
        theme_minimal() +
        theme(axis.text.y = element_text(size = 11)) +
        scale_y_continuous(expand = expansion(mult = c(0, 0.3)))  # Espa√ßo para r√≥tulos
    } else {
      # Gr√°fico vazio se n√£o houver dados
      ggplot() + 
        annotate("text", x = 0.5, y = 0.5, label = "Sem dados para exibir") +
        theme_void() +
        xlim(0, 1) + ylim(0, 1)
    }
  }
})

# Nuvem de palavras corrigida
output$nuvem_palavras <- renderPlot({
  req(input$min_freq_nuvem, input$max_palavras)
  
  # Selecionar os dados com base no tipo de contagem e se mostra palavras raras
  if (input$mostrar_raras) {
    # Mostrar palavras raras
    if (input$tipo_contagem_nuvem == "individual") {
      req(termos_raros())
      palavras_freq <- termos_raros() %>%
        filter(frequencia <= 3) %>%
        head(input$max_palavras)
    } else {
      req(termos_raros_agrupados())
      palavras_freq <- termos_raros_agrupados() %>%
        filter(frequencia <= 3) %>%
        head(input$max_palavras) %>%
        select(termo, frequencia)
    }
  } else {
    # Mostrar palavras frequentes (comportamento padr√£o)
    if (input$tipo_contagem_nuvem == "individual") {
      req(frequencia_termos())
      palavras_freq <- frequencia_termos() %>%
        filter(frequencia >= input$min_freq_nuvem) %>%
        head(input$max_palavras)
    } else {
      req(frequencia_termos_agrupados())
      palavras_freq <- frequencia_termos_agrupados() %>%
        filter(frequencia >= input$min_freq_nuvem) %>%
        head(input$max_palavras) %>%
        select(termo, frequencia)
    }
  }
  
  # Remover linhas com NA em qualquer coluna
  palavras_freq <- palavras_freq[complete.cases(palavras_freq), ]
  
  # Garantir que nomes de linhas est√£o corretos
  rownames(palavras_freq) <- NULL
  
  # Garantir que h√° palavras suficientes ap√≥s a filtragem
  if(nrow(palavras_freq) > 0) {
    set.seed(123)  # Para reprodutibilidade
    
    # Determinar o n√∫mero de cores necess√°rias (entre 3 e 8)
    n_cores <- min(8, max(3, min(8, nrow(palavras_freq))))
    
    # Escolher a paleta de cores com base no tipo de visualiza√ß√£o
    color_palette <- if(input$mostrar_raras) {
      brewer.pal(n_cores, "Pastel1")  # Cores mais suaves para palavras raras
    } else {
      brewer.pal(n_cores, "Dark2")    # Cores mais vibrantes para palavras frequentes
    }
    
    # Definir a frequ√™ncia m√≠nima corretamente
    freq_minima <- if(input$mostrar_raras) 1 else input$min_freq_nuvem
    
    tryCatch({
      wordcloud(words = palavras_freq$termo,
                freq = palavras_freq$frequencia,
                min.freq = freq_minima,
                max.words = input$max_palavras,
                random.order = FALSE,
                rot.per = 0.35,
                colors = color_palette,
                scale = c(4, 0.5))
    }, error = function(e) {
      # Em caso de erro, mostrar mensagem
      plot(0, 0, type = "n", axes = FALSE, xlab = "", ylab = "")
      text(0, 0, paste("Erro ao gerar nuvem:", e$message), cex = 1.2)
    })
  } else {
    # Mensagem para quando n√£o h√° palavras suficientes
    plot(0, 0, type = "n", axes = FALSE, xlab = "", ylab = "")
    text(0, 0, "N√£o h√° palavras suficientes com esta frequ√™ncia", cex = 1.5)
  }
})

# Busca inteligente na aba de Termos Frequentes
observeEvent(input$buscar, {
  req(output_text())
  req(input$busca_termo)
  
  # Buscar a palavra no texto
  resultado <- buscar_palavra_inteligente(output_text(), input$busca_termo, input$case_sensitive)
  
  # Exibir o resultado
  output$resultado_busca <- renderUI({
    if (resultado$total > 0) {
      # Calcular percentual do total de palavras
      percentual <- (resultado$total / total_palavras()) * 100
      
      tags$div(
        class = "well",
        style = "background-color: #f8f9fa; border-left: 4px solid #5bc0de; padding: 15px;",
        tags$div(
          tags$strong("Palavras encontradas: "),
          paste(length(resultado$palavras_encontradas), 
                ifelse(length(resultado$palavras_encontradas) == 1, "palavra", "palavras"), 
                "relacionadas a", tags$b(input$busca_termo))
        ),
        tags$div(
          style = "display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px;",
          lapply(resultado$palavras_encontradas, function(palavra) {
            # Contar ocorr√™ncias dessa palavra espec√≠fica
            ocorrencias_palavra <- sum(sapply(resultado$posicoes, function(pos) {
              if (!is.null(pos$posicoes)) {
                sum(pos$posicoes$palavra == palavra)
              } else {
                0
              }
            }))
            
            # Calcular percentual para esta palavra espec√≠fica
            percentual_palavra <- (ocorrencias_palavra / total_palavras()) * 100
            
            tags$span(
              class = "badge",
              style = "background-color: #5bc0de; margin: 2px; padding: 5px;",
              paste0(palavra, " (", ocorrencias_palavra, " - ", round(percentual_palavra, 2), "%)")
            )
          })
        ),
        tags$hr(),
        tags$p("Total de ocorr√™ncias: ", tags$b(paste0(resultado$total, " (", round(percentual, 2), "% do total)")), 
               " de um total de ", tags$b(total_palavras()), " palavras no documento"),
        tags$p("Distribui√ß√£o por p√°gina:"),
        tags$div(
          style = "display: flex; flex-wrap: wrap; gap: 5px;",
          lapply(seq_along(resultado$por_pagina), function(i) {
            if (resultado$por_pagina[i] > 0) {
              # Calcular percentual para esta p√°gina espec√≠fica em rela√ß√£o ao total de ocorr√™ncias
              percentual_pagina <- (resultado$por_pagina[i] / resultado$total) * 100
              
              tags$span(
                style = "background-color: #e2e3e5; padding: 3px 8px; border-radius: 4px; margin: 2px;",
                paste("P√°gina", i, ":", resultado$por_pagina[i], 
                      sprintf("(%.1f%%)", percentual_pagina))
              )
            }
          })
        )
      )
    } else {
      tags$div(
        class = "alert alert-danger",
        tags$strong("N√£o encontrado!"), 
        paste(" N√£o foram encontradas palavras relacionadas a", tags$b(input$busca_termo))
      )
    }
  })
})

# Vari√°vel reativa para armazenar os resultados da busca avan√ßada
resultados_busca_avancada <- reactiveValues(dados = NULL)

# Busca avan√ßada
observeEvent(input$buscar_avancado, {
  req(output_text())
  req(input$busca_avancada)
  
  # Buscar a palavra no texto
  resultado <- buscar_palavra_inteligente(output_text(), input$busca_avancada, input$case_sensitive_avancado)
  
  # Armazenar os resultados para uso posterior
  resultados_busca_avancada$dados <- resultado
  
  # Exibir as palavras encontradas
  output$palavras_encontradas <- renderUI({
    if (length(resultado$palavras_encontradas) > 0) {
      # Calcular percentual do total de palavras
      percentual_total <- (resultado$total / total_palavras()) * 100
      
      tags$div(
        class = "alert alert-info",
        tags$strong("Palavras encontradas: "),
        tags$div(
          style = "margin-bottom: 10px;",
          paste0("Encontradas ", length(resultado$palavras_encontradas), 
                " termos relacionados a '", input$busca_avancada, "', representando ",
                round(percentual_total, 2), "% do total de palavras do documento.")
        ),
        tags$div(
          style = "display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px;",
          lapply(resultado$palavras_encontradas, function(palavra) {
            # Contar ocorr√™ncias dessa palavra espec√≠fica
            ocorrencias_palavra <- sum(sapply(resultado$posicoes, function(pos) {
              if (!is.null(pos$posicoes)) {
                sum(pos$posicoes$palavra == palavra)
              } else {
                0
              }
            }))
            
            # Calcular percentual para esta palavra espec√≠fica
            percentual_palavra <- (ocorrencias_palavra / total_palavras()) * 100
            percentual_grupo <- (ocorrencias_palavra / resultado$total) * 100
            
            tags$span(
              class = "badge",
              style = "background-color: #5bc0de; margin: 2px; padding: 5px;",
              paste0(palavra, " (", ocorrencias_palavra, " - ", 
                    round(percentual_palavra, 2), "% do total, ", 
                    round(percentual_grupo, 1), "% do grupo)")
            )
          })
        )
      )
    } else {
      tags$div(
        class = "alert alert-danger",
        "Nenhuma palavra encontrada com este prefixo."
      )
    }
  })
  
  # Exibir o resultado da busca
  output$resultado_busca_avancada <- renderUI({
    if (resultado$total > 0) {
      # Calcular percentual do total de palavras
      percentual_total <- (resultado$total / total_palavras()) * 100
      
      tags$div(
        class = "alert alert-success",
        tags$strong("Resultados da busca:"), 
        paste(" Encontradas", resultado$total, 
              ifelse(resultado$total == 1, "ocorr√™ncia", "ocorr√™ncias"), 
              "de palavras relacionadas a", tags$b(input$busca_avancada),
              sprintf("(%.2f%% do total de palavras)", percentual_total)),
        tags$hr(),
        tags$p("Clique em uma p√°gina para ver o texto com destaque:"),
        tags$div(
          style = "display: flex; flex-wrap: wrap; gap: 10px;",
          lapply(seq_along(resultado$por_pagina), function(i) {
            if (resultado$por_pagina[i] > 0) {
              # Calcular percentual para esta p√°gina espec√≠fica
              percentual_pagina <- (resultado$por_pagina[i] / resultado$total) * 100
              
              actionButton(
                inputId = paste0("pagina_", i),
                label = paste("P√°gina", i, "(", resultado$por_pagina[i], 
                             sprintf(" - %.1f%%)", percentual_pagina)),
                class = "btn-sm btn-info",
                onclick = sprintf("Shiny.setInputValue('pagina_selecionada', %d);", i)
              )
            }
          })
        )
      )
    } else {
      tags$div(
        class = "alert alert-danger",
        tags$strong("Nenhum resultado!"), 
        paste(" N√£o foram encontradas palavras relacionadas a", tags$b(input$busca_avancada))
      )
    }
  })
})

# Observer para sele√ß√£o de p√°gina e destaque de texto
observeEvent(input$pagina_selecionada, {
  req(output_text())
  req(resultados_busca_avancada$dados)
  
  pagina <- as.numeric(input$pagina_selecionada)
  resultado <- resultados_busca_avancada$dados
  texto_pagina <- output_text()[pagina]
  palavras <- resultado$palavras_encontradas
  
  # Fun√ß√£o para destacar todas as palavras encontradas com cores diferentes
  destacar_texto <- function(texto, palavras, case_sensitive = FALSE) {
    texto_html <- texto
    
    # Gerar cores para cada palavra encontrada
    num_palavras <- length(palavras)
    cores <- colorRampPalette(brewer.pal(min(8, max(3, num_palavras)), "Set1"))(num_palavras)
    
    # Para cada palavra, adicionar destaque com uma cor espec√≠fica
    for (i in seq_along(palavras)) {
      palavra <- palavras[i]
      cor <- cores[i]
      padrao <- paste0("\\b", palavra, "\\b")
      
      texto_html <- gsub(
        pattern = padrao, 
        replacement = paste0('<span style="background-color: ', cor, '; color: white; font-weight: bold; padding: 0 2px; border-radius: 3px;">', "\\0", '</span>'),
        x = texto_html,
        ignore.case = !case_sensitive
      )
    }
    
    # Adicionar contador e legenda de cores
    texto_html <- paste0(
      '<div style="margin-bottom: 10px; font-size: 0.9em; background-color: #f0f0f0; padding: 5px; border-radius: 4px;">',
      '<strong>Legenda:</strong><br>',
      paste(sapply(seq_along(palavras), function(i) {
        palavra <- palavras[i]
        cor <- cores[i]
        # Contar ocorr√™ncias dessa palavra na p√°gina
        ocorrencias <- length(gregexpr(paste0("\\b", palavra, "\\b"), texto_pagina, ignore.case = !case_sensitive)[[1]])
        if (ocorrencias[1] != -1) {
          paste0('<span style="display: inline-block; margin: 2px 5px; padding: 0 5px; background-color: ', 
                cor, '; color: white; border-radius: 3px;">', palavra, 
                ' (', ocorrencias, ' ocorr√™ncias)</span>')
        } else {
          ""
        }
      }), collapse = " "),
      '</div>',
      texto_html
    )
    
    return(texto_html)
  }
  
  # Destacar o texto e renderizar
  texto_destacado <- destacar_texto(texto_pagina, palavras, input$case_sensitive_avancado)
  
  # Contar palavras na p√°gina
  palavras_pagina <- sum(resultado$por_pagina[pagina])
  palavras_total <- resultado$total
  percentual_pagina <- (palavras_pagina / palavras_total) * 100
  
  output$texto_destacado <- renderUI({
    tags$div(
      class = "panel panel-default",
      tags$div(
        class = "panel-heading",
        paste("P√°gina", pagina, "com destaque para palavras relacionadas a '", input$busca_avancada, "'"),
        tags$span(
          class = "badge pull-right",
          style = "background-color: #5bc0de;",
          paste0(palavras_pagina, " ocorr√™ncias (", round(percentual_pagina, 1), "% do total)")
        )
      ),
      tags$div(
        class = "panel-body",
        style = "max-height: 500px; overflow-y: auto; font-family: monospace; white-space: pre-wrap;",
        HTML(texto_destacado)
      )
    )
  })
})
```

## üìù Como usar

1. Clique no bot√£o "Procurar..." para selecionar um arquivo PDF
2. Clique no bot√£o "Analisar Documento" para processar o texto
3. Explore os resultados nas diferentes abas:
   - **Texto Extra√≠do**: Veja o conte√∫do do PDF, organizado por p√°gina
   - **Termos Frequentes**: 
     - Escolha entre contagem individual ou agrupada (combinando palavras similares)
     - Use o controle de frequ√™ncia m√≠nima para filtrar os termos
     - Use o buscador inteligente para encontrar palavras digitando apenas parte delas
     - Visualize frequ√™ncias absolutas e relativas (percentuais)
   - **Termos Raros**:
     - Analise as palavras menos frequentes no documento
     - Configure a frequ√™ncia m√°xima para definir o que √© considerado "raro"
     - Visualize em formato de tabela e gr√°fico com frequ√™ncias e percentuais
   - **Nuvem de Palavras**: 
     - Veja uma representa√ß√£o visual dos termos mais frequentes ou mais raros
     - Escolha entre visualiza√ß√£o individual ou agrupada
     - Configure o n√∫mero m√°ximo de palavras a serem exibidas
   - **Buscador Avan√ßado**:
     - Digite parte de uma palavra para encontrar todas as varia√ß√µes (com/sem acentos)
     - Veja a distribui√ß√£o das palavras encontradas por p√°gina com percentuais
     - Clique nas p√°ginas para ver o texto com as palavras destacadas em cores diferentes

### Sobre o agrupamentos de palavras:

A contagem agrupada combina palavras que s√£o essencialmente as mesmas, mas escritas de formas diferentes:
- Com ou sem acentos (ex: "manuten√ß√£o" e "manutencao")
- Mai√∫sculas ou min√∫sculas (ex: "Manuten√ß√£o" e "manuten√ß√£o")
- Pequenas varia√ß√µes ortogr√°ficas (ex: palavras com √ß/c, etc.)

### **OBS**

Palavras que possuem plural s√£o tratadas como palavras n√£o similares, exemplo:

Recurso (singular) Recursos (plural), se a palvra "recurso" aparecer 10x e a sua forma no plural "recursos" aparecer 20x, elas n√£o agrupa (10+20=30), mas mant√©m no relat√≥rio  as duas formas e a frequencia que elas apareceram.

- recurso 10
- recursos 20

Isso permite uma an√°lise mais precisa da frequ√™ncia real dos termos no documento.

